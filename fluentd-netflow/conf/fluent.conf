##########################################
#### NOTES
##########################################
# Be Sure and Replace the following variables:
# <MAILSERVER> = Local Mailserver
# <FROM EMAIL> = From Notifications Email
# <TO EMAIL> = To Notifications Email
###########################################

<source>
  type netflow
  tag netflow.event
  
  # optional parameters
  bind 0.0.0.0
  port 5550

  # optional parser parameters
  cache_ttl 6000
  versions [5, 9]
</source>

<match netflow.event>
  buffer_type memory
#  buffer_chunk_limit 800m
#  flush_interval 5s
#  flush_at_shutdown true
#  disable_retry_limit false
#  retry_limit 17
#  retry_wait 1s
</match>

<match netflow.event>
        @type geoip
        flush_interval 1s
        tag geoip.dst.${tag}
        geoip_lookup_key ipv4_dst_addr
        <record>
                dst_addr_latitude         ${latitude["ipv4_dst_addr"]}
                dst_addr_longitude        ${longitude["ipv4_dst_addr"]}
                dst_addr_country_code3    ${country_code3["ipv4_dst_addr"]}
                dst_addr_country          ${country_code["ipv4_dst_addr"]}
                dst_addr_country_name     ${country_name["ipv4_dst_addr"]}
                dst_addr_dma              ${dma_code["ipv4_dst_addr"]}
                dst_addr_area             ${area_code["ipv4_dst_addr"]}
                dst_addr_region           ${region["ipv4_dst_addr"]}
                dst_addr_city             ${city["ipv4_dst_addr"]}
                dst_location              ${latitude["ipv4_dst_addr"]},${longitude["ipv4_dst_addr"]}
        </record>
        skip_adding_null_record  true
        #log_level         info
</match>

<match geoip.dst.**>
        @type geoip
        flush_interval 1s
        tag geoip.complete.${tag}
        remove_tag_prefix geoip.dst.
        geoip_lookup_key ipv4_src_addr
        <record>
                src_addr_latitude         ${latitude["ipv4_src_addr"]}
                src_addr_longitude        ${longitude["ipv4_src_addr"]}
                src_addr_country_code3    ${country_code3["ipv4_src_addr"]}
                src_addr_country          ${country_code["ipv4_src_addr"]}
                src_addr_country_name     ${country_name["ipv4_src_addr"]}
                src_addr_dma              ${dma_code["ipv4_src_addr"]}
                src_addr_area             ${area_code["ipv4_src_addr"]}
                src_addr_region           ${region["ipv4_src_addr"]}
                src_addr_city             ${city["ipv4_src_addr"]}
                src_location              ${latitude["ipv4_src_addr"]},${longitude["ipv4_src_addr"]}
        </record>
        skip_adding_null_record  true
        #log_level         info
</match>

<match geoip.complete.**>
        @type record_reformer
        tag lookups_added
        <record>
            senderbase_lookup_src http://www.senderbase.org/lookup/?search_string=${ipv4_src_addr}
            spamhaus_lookup_src http://www.spamhaus.org/query/bl?ip=${ipv4_src_addr}
            senderbase_lookup_dst http://www.senderbase.org/lookup/?search_string=${ipv4_dst_addr}
            spamhaus_lookup_dst http://www.spamhaus.org/query/bl?ip=${ipv4_dst_addr}
        </record>
</match>

# Copy Everything to Elasticsearch and STDOUT
<match lookups_added.**>
        @type copy
        <store>
                @type elasticsearch
                host elasticsearch
                port 9200
                logstash_format true
                logstash_prefix netflow
                logstash_dateformat %Y.%m.
                reload_on_failure true
                index_name fluentd
                type_name fluentd
                utc_index true
                flush_interval 10s
                buffer_chunk_limit 800m
                flush_interval 5s
                flush_at_shutdown true
                disable_retry_limit false
                retry_limit 17
                retry_wait 1s
                num_threads 2
        </store>
        #<store>
        #        @type stdout
        #</store>
</match>
